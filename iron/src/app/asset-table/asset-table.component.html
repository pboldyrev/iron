<app-add-asset-popup
    #addAssetPopup
></app-add-asset-popup>
<app-confirmation-popup
  [title]="TEXTS.ARCHIVE_POPUP_TITLE_1 + assetToArchive?.assetName + TEXTS.ARCHIVE_POPUP_TITLE_2"
  [subtitle]="TEXTS.ARCHIVE_POPUP_SUBTITLE"
  [confirmText]="TEXTS.ARCHIVE_POPUP_CTA"
  size="large"
  (confirmed)="onArchiveAssetConfirmed()"
  #archiveConfirmPopup
></app-confirmation-popup>
<div class="asset-table">
    <div *ngIf="isLoading$ | async" class="asset-table-progress-bar">
        <mat-progress-bar mode="query"></mat-progress-bar>
    </div>
    <div *ngIf="!(isLoading$ | async) && ((assets$ | async) ?? []).length === 0">
        <blu-text type="secondary">No assets added yet... <blu-link (click)="onAddAsset()">Add one?</blu-link></blu-text>
    </div>
    <mat-table 
        *ngIf="!(isLoading$ | async) && !(showUnknownError$ | async) && ((assets$ | async) ?? []).length > 0" 
        #table 
        [dataSource]="(assets$ | async) ?? []"
    >
        
        <ng-container matColumnDef="account">
            <mat-header-cell *matHeaderCellDef>
                {{ TEXTS.ACCOUNT_TITLE }}
            </mat-header-cell>
            <mat-cell *matCellDef="let asset">
                <blu-text type="primary">{{asset.account}}</blu-text>
            </mat-cell>
            <mat-footer-cell *matFooterCellDef>
            </mat-footer-cell>
        </ng-container>

        <ng-container matColumnDef="type">
            <mat-header-cell *matHeaderCellDef>
                {{ TEXTS.TYPE_TITLE }}
            </mat-header-cell>
            <mat-cell *matCellDef="let asset">
                <blu-text type="primary" [capitalize]="true">{{asset.assetType}}</blu-text>
            </mat-cell>
            <mat-footer-cell *matFooterCellDef>
            </mat-footer-cell>
        </ng-container>

        <ng-container matColumnDef="asset">
            <mat-header-cell *matHeaderCellDef>
                {{ TEXTS.ASSET_TITLE }}
            </mat-header-cell>
            <mat-cell *matCellDef="let asset">
                <blu-text type="primary">{{asset.assetName}}</blu-text>
            </mat-cell>
            <mat-footer-cell *matFooterCellDef>
            </mat-footer-cell>
        </ng-container>

        <ng-container matColumnDef="units">
            <mat-header-cell *matHeaderCellDef>
                {{ TEXTS.UNITS_TITLE }}
            </mat-header-cell>
            <mat-cell *matCellDef="let asset">
                <blu-text type="number">{{ asset.units }}</blu-text>
            </mat-cell>
            <mat-footer-cell *matFooterCellDef>
            </mat-footer-cell>
        </ng-container>

        <ng-container matColumnDef="initValue">
            <mat-header-cell *matHeaderCellDef>
                {{ TEXTS.COST_TITLE }}
            </mat-header-cell>
            <mat-cell *matCellDef="let asset">
                <blu-text type="number">${{ (asset.initValue ?? 0).toLocaleString('en-US', {maximumFractionDigits: 2, minimumFractionDigits: 2}) }}</blu-text>
            </mat-cell>
            <mat-footer-cell *matFooterCellDef>
                <blu-text weight="bold" type="number">${{ initTotal.toLocaleString('en-US', {maximumFractionDigits: 2, minimumFractionDigits: 2}) }}</blu-text>
            </mat-footer-cell>
        </ng-container>

        <ng-container matColumnDef="curValue">
            <mat-header-cell *matHeaderCellDef>
                {{ TEXTS.VALUE_TITLE }}
            </mat-header-cell>
            <mat-cell *matCellDef="let asset" class="asset-table-value-cell">
                <blu-text type="number">${{(asset.curValue ?? 0).toLocaleString('en-US', {maximumFractionDigits: 2, minimumFractionDigits: 2}) }}</blu-text>
            </mat-cell>
            <mat-footer-cell *matFooterCellDef>
                <blu-text weight="bold" type="number">${{ curTotal.toLocaleString('en-US', {maximumFractionDigits: 2, minimumFractionDigits: 2}) }}</blu-text>
            </mat-footer-cell>
        </ng-container>

        <ng-container matColumnDef="change">
            <mat-header-cell *matHeaderCellDef>
            </mat-header-cell>
            <mat-cell *matCellDef="let asset" class="asset-table-align-left">
                <blu-tag [type]="asset.curValue >= asset.initValue ? 'success' : 'error'">
                    <blu-icon [name]="asset.curValue >= asset.initValue ? 'chevronUp' : 'chevronDown'"></blu-icon>
                    <div class="asset-table-tag-text">
                        <blu-text size="small" type="number">{{ getPercentChange(asset.initValue, asset.curValue) }}%</blu-text>
                    </div>
                </blu-tag>
            </mat-cell>
            <mat-footer-cell *matFooterCellDef>
                <blu-tag 
                    *ngIf="getPercentChange(initTotal, curTotal) !== 0"
                    [type]="initTotal >= curTotal ? 'success' : 'error'"
                >
                    <blu-icon 
                        [name]="initTotal >= curTotal ? 'chevronUp' : 'chevronDown'"
                    ></blu-icon>
                    <div class="asset-table-tag-text">
                        <blu-text size="small" type="number">
                            {{ getPercentChange(initTotal, curTotal) }}%
                        </blu-text>
                    </div>
                </blu-tag>
            </mat-footer-cell>
        </ng-container>

        <ng-container matColumnDef="edit">
            <mat-header-cell *matHeaderCellDef>
            </mat-header-cell>
            <mat-cell *matCellDef="let asset" class="asset-table-value-cell">
                <blu-button [iconOnly]="true" iconName="kebab" type="tertiary" class="asset-table-edit-menu" [matMenuTriggerFor]="appMenu"></blu-button>
                <mat-menu #appMenu="matMenu" xPosition="before" yPosition="below">
                    <div mat-menu-item (click)="onDetailsAsset(asset)"><blu-text type="primary" size="small">{{ TEXTS.ENTRY_BUTTON_DETAILS }}</blu-text></div>
                    <div mat-menu-item (click)="onArchiveAsset(asset)"><blu-text type="error" size="small">{{ TEXTS.ENTRY_BUTTON_ARCHIVE }}</blu-text></div>
                </mat-menu>
            </mat-cell>
            <mat-footer-cell *matFooterCellDef>
            </mat-footer-cell>
        </ng-container>

        <mat-header-row *matHeaderRowDef="columns"></mat-header-row>
        <mat-row *matRowDef="let row; columns: columns;"></mat-row>
        <mat-footer-row *matFooterRowDef="columns"></mat-footer-row>
    </mat-table>
    <blu-validation-feedback *ngIf="showUnknownError$ | async" [type]="FeedbackType.ERROR">Unknown error occured. <blu-link (click)="onPageReload()">Reload?</blu-link></blu-validation-feedback>
</div>